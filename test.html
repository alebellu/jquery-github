<html>
<head>
	<script src="http://code.jquery.com/jquery-1.7.2.js"></script>
	<script src="jquery.github-1.0.js"></script>
	<script src="lib/jquery.base64.min.js"></script>
	<script src="lib/jquery.cookie.js"></script>
	<script>
	if (!window.btoa) window.btoa = $.base64.encode;
	if (!window.atob) window.atob = $.base64.decode;

	$(document).ready(function() {
		/*if ( $().github( 'authorized' ) ) {
			if ( $().github( 'accessToken' ) ) {
				$( 'action auth' ).removeAttr( 'disabled' );
			} else {
				var accessTokenURL = $().github( 'accessTokenURL', {
					client_id: '8fd6c4f32a7af4fd44c7',
					client_secret: 'b52bbc3e2fdf407d444c0d6a302debb85b240641'
				} );
				window.location.href = accessTokenURL;
			}
		}
		else {
			$( 'action auth' ).attr( 'disabled', 'disabled' );
		}*/
	});

	function authorizeBasic() {
		$().github( 'encodedCredentials', window.btoa( $( '#user' ).val() + ':' + $( '#pwd' ).val() ) );
	}

	function authorizeOAuth() {
		var authURL = $().github( 'authorizeURL', {
			client_id: '8fd6c4f32a7af4fd44c7',
			scope: 'repo'
		});
		window.location.href = authURL;
	}

	function getTree( path ) {
		$( '#results' ).empty();
            	$().github( 'tree', {
            		user: 'alebellu',
            		repo: 'jquery-github',
            		tree: 'gh-pages',
            		path: path
            	}).done( function(tree) {
            		$( '#results' ).empty();
			for (var i = 0; i < tree.tree.length ; i ++) {
				var el = tree.tree[i];
				if ( el.type == 'blob' ) {
					$( '#results' ).append( $( '<li>' ).html( el.path + ' ' + el.size ) );
				} else {
					$( '#results' ).append( $( '<li>' ).html( '[' + el.path + ']' ) );
				}
			}
		});
	}

	function getBlob() {
		$( '#results' ).empty();
    		$().github( 'blob', {
    			user: 'alebellu',
    			repo: 'jquery-github',
    			tree: 'gh-pages',
    			path: 'test/count'
    		}).done( function( blob ) {
    			var content = window.atob( blob.content.trim() );
			$( '#results' ).empty().append( $( '<li>' ).html( content ) );
    		});
	}

	function increaseCount() {
		$( '#results' ).empty();
    		$().github( 'blob', {
    			user: 'alebellu',
    			repo: 'jquery-github',
    			tree: 'gh-pages',
    			path: 'test/count'
    		}).done( function( blob ) {
    			var content = window.atob( blob.content.trim() );
    			content = '' + (parseInt( content ) + 1);
    			var encodedContent = window.btoa( content );
	    		$().github( 'commit', {
	    			user: 'alebellu',
	    			repo: 'jquery-github',
	    			commit_ref: 'heads/gh-pages',
	    			tree: 'gh-pages',
	    			new_tree: [{
					path: 'test/count',
	    				content: content
	    			}],
	    			message: 'increasing count'
	    		}).done( function() {
		    		getBlob();
	    		});
    		});
	}
	//alert($.cookie('ghtoken'));
	</script>
</head>
<body>
	<div id="content">
		<h1>JQuery GitHub Library Test</h1>
		<input type="text" id="user" />
		<input type="password" id="pwd" />
		<input type="button" value="Set basic auth data" onclick="authorizeBasic()" />
		<input type="button" value="OAuth" onclick="authorizeOAuth()" />
		<input type="button" class="action no-auth" value="Get root tree" onclick="getTree()" />
		<input type="button" class="action no-auth" value="Get tree at path 'test'" onclick="getTree('test')" />
		<input type="button" class="action no-auth" value="Get blob 'test/count'" onclick="getBlob()" />
		<input type="button" class="action auth" value="Increase 'test/count'" onclick="increaseCount()" />
		<hr />
		<ul id="results" />
	</div>
</body>
</html>
